function BrightLegend(b){this.legend=function(){var a=b.canvas().append("g").attr("class","legend"+b.chart_identifier()).selectAll("rect.legenditem").data(b.color.domain()),c=a.enter().append("rect").attr("class","legenditem"+b.chart_identifier()).attr("width",15).attr("height",15).attr("transform",function(a,c){return 2>=c?"translate( "+180*c+", "+(b.inner_height()+30)+")":5>=c?"translate( "+180*(c-3)+", "+(b.inner_height()+50)+")":"translate( "+180*(c-6)+", "+(b.inner_height()+70)+")"}).attr("fill",
function(a,c){return b.color(a)}),c=a.enter().append("text").attr("class","legenditemtext"+b.chart_identifier()).attr("dx",18).attr("dy",12).attr("style","font-size: 12px").attr("transform",function(a,c){return 2>=c?"translate( "+180*c+", "+(b.inner_height()+30)+")":5>=c?"translate( "+180*(c-3)+", "+(b.inner_height()+50)+")":"translate( "+180*(c-6)+", "+(b.inner_height()+70)+")"});c.text(function(a,b){return a})};return this.legend()};function BrightTooltips(b){this.tooltips=function(){var a=b.canvas().append("g").attr("class","focus").style("display","none");a.append("rect").attr("class","y0").attr("width",0.75).attr("height",b.inner_height()-15);a.append("text").attr("class","y0").attr("style","font-size: 12px").attr("dy","-1em");this.legend_place=a.append("rect").attr("class","tpbox").attr("width","200").attr("height",21*b.color.domain().length).attr("style","fill: white; opacity: 0.7");a.append("text").attr("class","tpcontent").attr("style",
"font-size: 12px").attr("dy","20").attr("dx","20");var c=a.append("g"),d=c.selectAll("rect.tooltipitem").data(b.color.domain()),e=d.enter().append("rect").attr("class","tooltipitem").attr("width",15).attr("height",15).attr("transform",function(a,b){return"translate( 0, "+20*b+")"}).attr("fill",function(a,c){return b.color(a)}),e=d.enter().append("text").attr("class","tooltipitemtext").attr("dx",18).attr("dy",12).attr("style","font-size: 12px").attr("transform",function(a,b){return"translate( 0, "+
20*b+")"});b.canvas().append("rect").attr("style","fill: transparent").attr("width",b.inner_width()).attr("height",b.inner_height()).on("mouseover",function(){a.style("display",null)}).on("mouseout",function(){a.style("display","none")}).on("mousemove",function(){var d=b.x_scale.invert(d3.mouse(this)[0]),d=g(b.dataset(),d,1),f=b.dataset()[d],k=b.shift?b.dataset()[d+b.shift]:f;a.select("rect.y0").transition().duration(50).attr("transform","translate("+b.x_scale(f.date)+", 15)");e.text(function(a,b){return""+
a+" "+parseInt(k[a])});200<b.inner_width()-b.x_scale(f.date)?(a.select("rect.tpbox").attr("transform","translate("+b.x_scale(f.date)+", 15)"),c.attr("transform","translate("+(b.x_scale(f.date)+5)+", 20)")):(a.select("rect.tpbox").attr("transform","translate("+b.x_scale(f.date)+", 15)"),a.select("rect.tpbox").attr("transform","translate("+(b.x_scale(f.date)-200)+", 15)"),c.attr("transform","translate("+(b.x_scale(f.date)-200+5)+", 20)"));a.select("text.y0").transition().duration(50).attr("transform",
"translate( 10, 20)").text(k.date)});var g=d3.bisector(function(a){return a.date}).left};return this.tooltips()};function BrightCropper(b){this.cropper=function(){b.canvas_object.canvas().append("g").append("defs").append("clipPath").attr("id","clippast"+b.chart_identifier()).append("rect").attr("width",b.canvas_object.inner_width()).attr("height",b.canvas_object.inner_height());b.canvas_object.chart_space().attr("clip-path","url(#clippast"+b.chart_identifier()+")");b.canvas_object.canvas().append("g").append("defs").append("clipPath").attr("id","cropxaxisright"+b.chart_identifier()).append("rect").attr("transform",
"translate(-5,"+(b.canvas_object.inner_height()-2)+")").attr("width",b.canvas_object.inner_width()+5).attr("height",20);return{}};return this.cropper()};function BrightListener(b){var a=this;this.initial_dataset=b.initial_dataset();this.day_distance=b.x_scale(new Date(0))-b.x_scale(new Date(b.time_interval()));this.chart=b.chart;this.painted_x_axis=b.painted_x_axis;this.painted_y_axis=b.painted_y_axis;this.area=b.area;this.chart_place=b.chart_place;this.steps=1;this.listen=function(){};this.listen.push=function(c){a.listen.enrich_initial_dataset(c);var d=new b.reader({date_format:b.date_format,dataset:function(){return a.initial_dataset}}),e=new b.scales({y_max:d.y_max,
dataset:d.dataset,width:function(){return b.width()-a.day_distance},height:b.height});c=new b.axis({chart_identifier:b.chart_identifier,skip:!0,painted_x:a.painted_x_axis,painted_y:a.painted_y_axis,canvas:b.canvas,x_scale:e.x_scale,y_scale:e.y_scale,height:b.height});var g=d3.svg.area().interpolate("monotone").x(function(a){return b.x_scale(a.date)}).y0(function(a){return e.y_scale(a.y0)}).y1(function(a){return e.y_scale(a.y0+a.y)});a.chart_place=a.chart_place.data(d.stacked_dataset());a.chart_place.attr("transform",
"translate("+a.day_distance*(a.steps-1)+",0)").attr("d",function(b){return a.area(b.values)}).transition().duration(1E3).attr("transform","translate("+a.day_distance*a.steps+",0)").attr("d",function(a){return g(a.values)});a.chart_place.enter().append("path").attr("d",function(b){return a.area(b.values)}).transition().duration(1E3).attr("transform","translate("+a.day_distance*a.steps+",0)").style("fill",function(a){return d.color(a.name)}).attr("d",function(a){return g(a.values)});a.chart_place.exit().remove();
a.painted_y_axis.transition().duration(1E3).call(c.y_axis);c.painted_x_axis.attr("transform","translate("+0*a.day_distance+","+b.height()+")");c.painted_x_axis.transition().duration(1E3).attr("transform","translate("+1*a.day_distance+","+b.height()+")");legend_settings={};legend_settings.x_scale=e.x_scale;legend_settings.canvas=b.canvas;legend_settings.inner_height=b.height;legend_settings.inner_width=b.width;legend_settings.color=d.color;legend_settings.dataset=d.dataset;legend_settings.chart_identifier=
b.chart_identifier;d3.select(".legend"+b.chart_identifier()).remove();new b.legend(legend_settings);tooltips_settings={};tooltips_settings.x_scale=e.x_scale;tooltips_settings.canvas=b.canvas;tooltips_settings.chart_space=b.chart_space;tooltips_settings.inner_height=b.height;tooltips_settings.inner_width=b.width;tooltips_settings.color=d.color;tooltips_settings.dataset=d.dataset;tooltips_settings.shift=1;new b.tooltips(tooltips_settings);a.area=g;a.initial_dataset.shift();a.steps++;return a.listen};
this.listen.enrich_initial_dataset=function(b){a.initial_dataset.push(b);var d=a.initial_dataset.length;d3.keys(b).forEach(function(b){for(var c=0;c<d;)a.initial_dataset[c][b]||(a.initial_dataset[c][b]="0"),c++});d3.keys(a.initial_dataset[0]).forEach(function(b){for(var c=0;c<d;)a.initial_dataset[c][b]||(a.initial_dataset[c][b]="0"),c++});d3.keys(a.initial_dataset[0]).forEach(function(b){for(var c=0,h=!0;c<d;)"0"!=a.initial_dataset[c][b]&&(h=!1),c++,c==d&&!0==h&&a.initial_dataset.forEach(function(a){delete a[b]})})};
return this.listen};function BrightStackedArea(b){this.chart=function(){var a={};a.area=d3.svg.area().interpolate("monotone").x(function(a){return b.x_scale(a.date)}).y0(function(a){return b.y_scale(a.y0)}).y1(function(a){return b.y_scale(a.y0+a.y)});a.chart_identifier="chart-"+Math.floor(1E7*Math.random());a.chart_place=b.chart_space().selectAll("."+a.chart_identifier).data(b.dataset());a.chart=a.chart_place.enter().append("path").attr("class",""+a.chart_identifier).attr("class","area").attr("d",function(b){return a.area(b.values)}).style("fill",
function(a){return b.color(a.name)});a.chart_place.exit().remove();return a};return this.chart()};function BrightReader(b){var a=this;this.dataset=JSON.parse(JSON.stringify(b.dataset()));this.y_max=0;this.color=this.stacked_dataset=null;this.reader=function(){var b={};a.reader.parse_dates();a.reader.enrich_dataset();a.color=d3.scale.category20();a.color.domain(d3.keys(a.dataset[0]).filter(function(a){return"date"!==a}));a.reader.stacked_dataset();a.reader.get_y_max();b.dataset=a.reader.dataset;b.stacked_dataset=a.reader.stacked_dataset;b.color=a.reader.color();b.y_max=a.y_max;return b};this.reader.get_y_max=
function(){var b=d3.keys(a.dataset[0]).filter(function(a){return"date"!==a});a.dataset.forEach(function(d){var e=b.map(function(a){return d[a]/1}).reduce(function(a,b){return a+b});a.y_max<e&&(a.y_max=e)})};this.reader.dataset=function(){return a.dataset};this.reader.color=function(){return a.color};this.reader.stacked_dataset=function(){if(!a.stacked_dataset){var b=d3.layout.stack().values(function(a){return a.values});a.stacked_dataset=b(a.color.domain().map(function(b){return{name:b,values:a.dataset.map(function(a){return{date:a.date,
y:a[b]/1}})}}))}return a.stacked_dataset};this.reader.parse_date=function(a){return d3.time.format(b.date_format()).parse(a)};this.reader.parse_dates=function(){a.dataset.forEach(function(b){b.date=a.reader.parse_date(b.date)})};this.reader.enrich_dataset=function(){var b=a.dataset.length;d3.keys(a.dataset[0]).forEach(function(d){for(var e=0;e<b;)a.dataset[e][d]||(a.dataset[e][d]="0"),e++});d3.keys(a.dataset[0]).forEach(function(d){for(var e=0,g=!0;e<b;)"0"!=a.dataset[e][d]&&(g=!1),e++,e==b&&!0==
g&&a.dataset.forEach(function(a){delete a[d]})})};return this.reader()};function BrightAxis(b){var a=this;this.x_axis_place=b.canvas().append("g").attr("clip-path","url(#cropxaxisright"+b.chart_identifier()+" )").append("g").attr("class","x axis").attr("transform","translate(0,"+b.height()+")");this.y_axis_place=b.canvas().append("g").attr("clip-path","url(#cropxayisright"+b.chart_identifier()+" )").append("g").attr("class","x axis");this.y_axis=this.x_axis=null;this.axis=function(){var c={};c.x_axis=a.axis.x_axis();c.y_axis=a.axis.y_axis();c.x_axis_place=a.x_axis_place;
c.y_axis_place=a.y_axis_place;var d=b.painted_y||a.y_axis_place;c.painted_x_axis=(b.painted_x||a.x_axis_place).call(c.x_axis);b.skip||(c.painted_y_axis=d.call(c.y_axis));return c};this.axis.x_axis=function(){a.x_axis||(a.x_axis=d3.svg.axis().scale(b.x_scale).orient("bottom"));return a.x_axis};this.axis.y_axis=function(){a.y_axis||(a.y_axis=d3.svg.axis().scale(b.y_scale).orient("left"));return a.y_axis};return a.axis()};function BrightScales(b){var a=this;this.y_scale=this.x_scale=null;this.scales=function(){var c={};c.x_scale=a.scales.x_scale();c.y_scale=a.scales.y_scale();a.x_scale.domain(d3.extent(b.dataset(),function(a){return a.date}));a.y_scale.domain([0,parseInt(b.y_max+0.1*b.y_max)]);return c};this.scales.x_scale=function(){a.x_scale||(a.x_scale=d3.time.scale().range([0,b.width()]));return a.x_scale};this.scales.y_scale=function(){a.y_scale||(a.y_scale=d3.scale.linear().range([b.height(),0]));return a.y_scale};
return a.scales()};function BrightBuilder(b){var a=this;this.chart_object=this.dataset_object=this.axis_object=this.scales_object=this.canvas_object=null;this.builder=function(){return a.builder.draw_canvas().read_initial_dataset().prepare_scales().build_axis().build_chart().crop_edges().prepare_legend().prepare_tooltips().listen()};this.builder.canvas_object=function(){return a.canvas_object};this.builder.scales_object=function(){return a.scales_object};this.builder.axis_object=function(){return a.axis_object};this.builder.dataset_object=
function(){return a.dataset_object};this.builder.chart_object=function(){return a.chart_object};this.builder.read_initial_dataset=function(){var c={};c.dataset=b.settings.initial_dataset;c.date_format=b.settings.date_format;a.dataset_object=new b.reader(c);return a.builder};this.builder.draw_canvas=function(){var c={};c.width=b.settings.width;c.height=b.settings.height;c.target=b.settings.target;a.canvas_object=new b.canvas(c);return a.builder};this.builder.prepare_scales=function(){var c={};c.dataset=
a.dataset_object.dataset;c.y_max=a.dataset_object.y_max;c.width=a.canvas_object.inner_width;c.height=a.canvas_object.inner_height;a.scales_object=new b.scales(c);return a.builder};this.builder.build_axis=function(){var c={};c.canvas=a.canvas_object.canvas;c.chart_identifier=b.settings.chart_identifier;c.x_scale=a.scales_object.x_scale;c.y_scale=a.scales_object.y_scale;c.height=a.canvas_object.inner_height;a.axis_object=new b.axis(c);return a.builder};this.builder.build_chart=function(){var c={};c.chart_space=
a.canvas_object.chart_space;c.dataset=a.dataset_object.stacked_dataset;c.color=a.dataset_object.color;c.x_scale=a.scales_object.x_scale;c.y_scale=a.scales_object.y_scale;a.chart_object=new b.chart(c);return a.builder};this.builder.crop_edges=function(){var c={};c.canvas_object=a.canvas_object;c.chart_identifier=b.settings.chart_identifier;c.axis_object=a.axis_object;a.crop_object=new b.cropper(c);return a.builder};this.builder.prepare_tooltips=function(){var c={};c.x_scale=a.scales_object.x_scale;
c.canvas=a.canvas_object.canvas;c.chart_space=a.canvas_object.chart_space;c.inner_height=a.canvas_object.inner_height;c.inner_width=a.canvas_object.inner_width;c.color=a.dataset_object.color;c.dataset=a.dataset_object.dataset;a.tooltips_object=new b.tooltips(c);return a.builder};this.builder.prepare_legend=function(){var c={};c.x_scale=a.scales_object.x_scale;c.canvas=a.canvas_object.canvas;c.inner_height=a.canvas_object.inner_height;c.inner_width=a.canvas_object.inner_width;c.color=a.dataset_object.color;
c.dataset=a.dataset_object.dataset;c.chart_identifier=b.settings.chart_identifier;a.legend_object=new b.legend(c);return a.builder};this.builder.listen=function(){var c={};c.time_interval=b.settings.time_interval;c.tooltips=b.tooltips;c.legend=b.legend;c.canvas=a.canvas_object.canvas;c.chart=a.chart_object.chart;c.chart_identifier=a.chart_object.chart_identifier;c.chart_place=a.chart_object.chart_place;c.chart_space=a.canvas_object.chart_space;c.area=a.chart_object.area;c.reader=b.reader;c.date_format=
b.settings.date_format;c.x_scale=a.scales_object.x_scale;c.y_scale=a.scales_object.y_scale;c.width=a.canvas_object.inner_width;c.height=a.canvas_object.inner_height;c.scales=b.scales;c.painted_x_axis=a.axis_object.painted_x_axis;c.painted_y_axis=a.axis_object.painted_y_axis;c.axis=b.axis;c.chart_identifier=b.settings.chart_identifier;c.initial_dataset=b.settings.initial_dataset;return new b.listener(c)};this.builder.build=function(){return a.builder()};return a.builder};function BrightCanvas(b){var a=this;this.margin={top:20,right:20,bottom:85,left:50};this.canvas_element=d3.select(b.target()).append("svg").attr("style","background-color: transparent").attr("width",b.width()).attr("height",b.height()).append("g").attr("transform","translate("+a.margin.left+","+a.margin.top+")");this.chart_space=a.canvas_element.append("g");this.canvas=function(){var b={};b.canvas=a.canvas.canvas;b.chart_space=a.canvas.chart_space;b.inner_width=a.canvas.inner_width;b.inner_height=
a.canvas.inner_height;return b};this.canvas.chart_space=function(){return a.chart_space};this.canvas.canvas=function(){return a.canvas_element};this.canvas.inner_width=function(){return b.width()-a.margin.left-a.margin.right};this.canvas.inner_height=function(){return b.height()-a.margin.top-a.margin.bottom};return this.canvas()};function Bright(){var b=this;this.width=100;this.height=200;this.target="body";this.date_format="%y-%b-%d";this.time_interval=5E3;this.initial_dataset=[];this.data_stream=null;this.chart_identifier="chart"+Math.floor(1E7*Math.random());this.chart_type="stacked-area";this.settings=function(){var a={};a.settings=b.settings;a.canvas=BrightCanvas;a.scales=BrightScales;a.axis=BrightAxis;a.chart=BrightStackedArea;a.reader=BrightReader;a.cropper=BrightCropper;a.tooltips=BrightTooltips;a.legend=BrightLegend;
a.listener=BrightListener;return(new BrightBuilder(a)).build()};this.settings.activate=function(){return b.settings()};this.settings.chart_identifier=function(){return b.chart_identifier};this.settings.time_interval=function(a){if(!arguments.length)return b.time_interval;b.time_interval=a;return b.settings};this.settings.date_format=function(a){if(!arguments.length)return b.date_format;b.date_format=a;return b.settings};this.settings.chart_type=function(a){if(!arguments.length)return b.chart_type;
b.chart_type=a;return b.settings};this.settings.initial_dataset=function(a){if(!arguments.length)return b.initial_dataset;b.initial_dataset=a;return b.settings};this.settings.data_stream=function(a){if(!arguments.length)return b.data_stream;b.data_stream=a;return b.settings};this.settings.target=function(a){if(!arguments.length)return b.target;b.target=a;return b.settings};this.settings.width=function(a){if(!arguments.length)return b.width;b.width=a;return b.settings};this.settings.height=function(a){if(!arguments.length)return b.height;
b.height=a;return b.settings};return b.settings}var bright=Bright();
